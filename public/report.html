<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Отчеты</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">

  <!-- Подключаем Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <script>
    // Загружаем общий header
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/header.html')
            .then(response => response.text())
            .then(data => {
                document.body.insertAdjacentHTML('afterbegin', data); // Вставляем шапку в начало body
            })
            .catch(err => console.error('Ошибка загрузки шапки:', err));
    });
  </script>

<div class="container my-5">

  <!-- Таблица отчетов -->
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>№</th>
        <th>Название отчета</th>
        <th>Дата создания</th>
        <th>Действие</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>1</td>
        <td>Диаграмма состояния компьютеров</td>
        <td>04.01.2024</td>
        <td>
          <button id="toggleChart" class="btn btn-info btn-sm">
            <i class="bi bi-bar-chart-line"></i> Диаграмма
          </button>
        </td>
      </tr>
      <tr>
        <td>2</td>
        <td>Самый активный компьютер</td>
        <td>04.01.2024</td>
        <td>
          <button id="loadMostActiveComputerBtn" class="btn btn-info btn-sm">
            <i class="bi bi-bar-chart-line"></i> Диаграмма
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Контейнер для отчетов -->
  <div id="reportsContainer">
    <!-- Сюда будут добавляться отчеты -->
  </div>

</div>

  <script>
    // Загружаем данные о компьютерах и создаем диаграмму статусов
    async function loadComputers() {
        try {
            const response = await fetch('/api/computers');
            const data = await response.json();
            const statuses = await fetch('/api/status');
            const statusData = await statuses.json();

            const statusCounts = { 'Работает': 0, 'Выключен': 0, 'В ремонте': 0 };
            data.forEach(computer => {
                const matchingStatus = statusData.find(status => status.PK_State === computer.PK_State);
                const statusText = matchingStatus ? matchingStatus.State : 'Неизвестен';
                if (statusCounts[statusText] !== undefined) {
                    statusCounts[statusText]++;
                }
            });

            const ctx = document.getElementById('computerStatusChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Работает', 'Выключен', 'В ремонте'],
                    datasets: [{
                        label: 'Статусы компьютеров',
                        data: [statusCounts['Работает'], statusCounts['Выключен'], statusCounts['В ремонте']],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                        borderColor: ['#fff', '#fff', '#fff'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return tooltipItem.label + ': ' + tooltipItem.raw + ' компьютеров';
                                }
                            }
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Ошибка при загрузке данных:', error);
        }
    }

    window.onload = loadComputers;

    // Функция для загрузки и отображения диаграммы самых активных компьютеров
    async function loadMostActiveComputers() {
        try {
            const response = await fetch('/api/most_active_computers');
            const data = await response.json();

            const labels = data.map(item => item.Domain_name);

            // Преобразуем время в часы и минуты
            const sessionTimes = data.map(item => {
                const totalMinutes = item.TotalSessionTime * 60; // Суммарное время в минутах
                const hours = Math.floor(totalMinutes / 60);
                const minutes = Math.round(totalMinutes % 60);
                return `${hours}ч ${minutes}мин`;
            });

            const rawSessionTimes = data.map(item => item.TotalSessionTime); // Для отображения точных значений в подсказках

            const ctx = document.getElementById('mostActiveComputerChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Суммарное время сессий',
                        data: rawSessionTimes,
                        backgroundColor: '#007bff',
                        borderColor: '#fff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                // Форматируем отображение времени в подсказке
                                label: function(tooltipItem) {
                                    const totalMinutes = rawSessionTimes[tooltipItem.dataIndex] * 60; // Суммарное время в минутах
                                    const hours = Math.floor(totalMinutes / 60);
                                    const minutes = Math.round(totalMinutes % 60);
                                    return `${tooltipItem.label}: ${hours}ч ${minutes}мин`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Компьютеры'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Суммарное время (часы)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Ошибка при загрузке данных о самых активных компьютерах:', error);
        }
    }



    // Добавляем обработчик для кнопки загрузки диаграммы самых активных компьютеров
    document.getElementById('loadMostActiveComputerBtn').addEventListener('click', loadMostActiveComputers);
  </script>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.5/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    // Переменные для отслеживания состояния диаграмм
    const reportsContainer = document.getElementById('reportsContainer');
    const reportStates = {
      chartContainer: false, // Состояние для диаграммы "Статусы компьютеров"
      mostActiveChartContainer: false // Состояние для диаграммы "Самый активный компьютер"
    };
  
    // Универсальная функция управления диаграммами
    function toggleReport(reportId, createCallback) {
      // Проверяем, существует ли диаграмма в DOM
      let reportDiv = document.getElementById(reportId);
  
      if (reportStates[reportId]) {
        // Если диаграмма уже отображена, скрываем её
        reportDiv.style.display = 'none';
        reportStates[reportId] = false; // Обновляем состояние диаграммы
        // Удаляем старую диаграмму, чтобы анимация срабатывала при каждом открытии
        const existingDiv = document.getElementById(reportId);
        if (existingDiv) {
          existingDiv.remove();
          reportStates[reportId] = false; // Сброс состояния
        }
        
      } else {
        // Если диаграммы ещё нет, создаём её через callback
        if (!reportDiv) {
          reportDiv = createCallback();
          reportDiv.id = reportId;
          reportDiv.classList.add('mt-3');
          reportsContainer.appendChild(reportDiv);
        }
  
        // Показываем диаграмму
        reportDiv.style.display = 'block';
        reportStates[reportId] = true; // Обновляем состояние диаграммы
  
        // Скрываем все другие диаграммы и сбрасываем их состояние
        Object.keys(reportStates).forEach(id => {
          if (id !== reportId) {
            const div = document.getElementById(id);
            if (div) div.style.display = 'none';
            reportStates[id] = false; // Сброс состояния других диаграмм
            const existingDiv = document.getElementById(id);
            if (existingDiv) {
              existingDiv.remove();
              reportStates[id] = false; // Сброс состояния
            }
          }
        });
      }
    }
  
    // Обработчик для кнопки диаграммы "Статусы компьютеров"
    document.getElementById('toggleChart').addEventListener('click', () => {
      toggleReport('chartContainer', () => {
        const chartDiv = document.createElement('div');
        chartDiv.innerHTML = 
          `<h3>Статусы компьютеров</h3>
          <canvas id="computerStatusChart" width="350" height="350"></canvas>`;
        loadComputers(); // Загружаем данные для диаграммы сразу после её создания
        return chartDiv;
      });
    });
  
    // Обработчик для кнопки диаграммы "Самый активный компьютер"
    document.getElementById('loadMostActiveComputerBtn').addEventListener('click', () => {
      toggleReport('mostActiveChartContainer', () => {
        const activeChartDiv = document.createElement('div');
        activeChartDiv.innerHTML = 
          `<h3>Самый активный компьютер</h3>
          <canvas id="mostActiveComputerChart" width="350" height="350"></canvas>`;
        loadMostActiveComputers(); // Загружаем данные для диаграммы сразу после её создания
        return activeChartDiv;
      });
    });
  </script>

</body>
</html>
